<ng-container *ngIf="isLoading; else content">
  <mat-progress-spinner [diameter]="100" mode="indeterminate" color="primary"></mat-progress-spinner>
</ng-container>
<ng-template #content>
  <mat-list>
    <mat-list-item>
      <a [routerLink]="['/jobs']">{{ 'MANUFACTURING.TITLE' | translate }}</a>
      / {{ jobDetail?.workEffortId }}
    </mat-list-item>
  </mat-list>
  <mat-card class="mat-elevation-z10">
    <mat-card-header>
      <mat-card-title>
        {{ 'COMMON.OVERVIEW' | translate }}
      </mat-card-title>
      <span class="spacer"></span>
      <button mat-stroked-button color="primary" (click)="approveJob()" *ngIf="!isApproved() && !isClosed()">
        {{ 'COMMON.APPROVE' | translate }}
      </button>
      <button mat-stroked-button color="accent" (click)="startJob()"
        *ngIf="isApproved() && !isRunning() && !isCompleted() && !isClosed()">
        {{ 'MANUFACTURING.START' | translate }}
      </button>
      <button mat-stroked-button color="primary" (click)="completeJob()"
        *ngIf="isRunning() && !isCompleted() && !isClosed()">
        {{ 'MANUFACTURING.COMPLETE' | translate }}
      </button>
      <button mat-stroked-button color="warn" (click)="closeJob()" *ngIf="isCompleted() && !isClosed()">
        {{ 'MANUFACTURING.CLOSE' | translate }}
      </button>
    </mat-card-header>
    <mat-card-content>
      <div fxLayout="row wrap" fxLayout.xs="column">
        <mat-card fxFlex.gt-xs="32%" class="card-margin mat-elevation-z10">
          <mat-card-content>
            <ul class="custom-list">
              <li class="custom-list-item">
                <strong>{{ 'MANUFACTURING.JOB_NAME' | translate }}:</strong>
                {{ jobDetail?.workEffortName }}
              </li>
              <li class="custom-list-item">
                <strong>{{ 'COMMON.FACILITY_ID' | translate }}:</strong>
                {{ jobDetail?.facilityId }}
              </li>
              <li class="custom-list-item">
                <strong>{{ 'MANUFACTURING.EST_START_DATE' | translate }}:</strong>
                {{ jobDetail?.estimatedStartDate | date : "MMMM d, y" }}
              </li>
              <li class="custom-list-item">
                <strong>{{ 'MANUFACTURING.STATUS_ID' | translate }}:</strong>
                {{ statusLabel(jobDetail?.currentStatusId || jobDetail?.statusId) }}
              </li>
              <li class="custom-list-item">
                <strong>{{ 'MANUFACTURING.ACTUAL_START_DATE' | translate }}:</strong>
                {{ (jobDetail?.actualStartDate || jobDetail?.estimatedStartDate) | date : "MMMM d, y" }}
              </li>
              <li class="custom-list-item">
                <strong>{{ 'MANUFACTURING.EST_HOURS' | translate }}:</strong>
                {{ jobDetail?.estimatedWorkDuration }}
              </li>
            </ul>
          </mat-card-content>
        </mat-card>
        <mat-card fxFlex.gt-xs="32%" class="card-margin mat-elevation-z10">
          <mat-card-content>
            <ul class="custom-list">
              <li class="custom-list-item">
                <strong>{{ 'COMMON.QOH' | translate }}:</strong>
                {{ jobDetail?.quantityOnHandTotal }}
              </li>
              <li class="custom-list-item">
                <strong>{{ 'COMMON.ATP' | translate }}:</strong>
                {{ jobDetail?.availableToPromiseTotal }}
              </li>
            </ul>
          </mat-card-content>
        </mat-card>
      </div>
    </mat-card-content>
  </mat-card>
  <br />
  <mat-card class="mat-elevation-z10">
    <mat-card-header>
      <mat-card-title>{{ 'MANUFACTURING.PRODUCTS_TO_PRODUCE' | translate }}</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <table mat-table [dataSource]="productsToProduce">
        <ng-container matColumnDef="productId">
          <th mat-header-cell class="text-left" *matHeaderCellDef>
            {{ 'COMMON.PRODUCT_ID' | translate }}
          </th>
          <td mat-cell class="text-left" *matCellDef="let item">
            {{ item?.productId }}
          </td>
        </ng-container>
        <ng-container matColumnDef="productName">
          <th mat-header-cell class="text-left" *matHeaderCellDef>
            {{ 'COMMON.PRODUCT_NAME' | translate }}
          </th>
          <td mat-cell class="text-left" *matCellDef="let item">
            {{ item?.productName }}
          </td>
        </ng-container>
        <ng-container matColumnDef="atp">
          <th mat-header-cell class="text-right" *matHeaderCellDef>{{ 'COMMON.ATP' | translate }}</th>
          <td mat-cell class="text-right" *matCellDef="let item">
            {{ item?.availableToPromiseTotal }}
          </td>
        </ng-container>
        <ng-container matColumnDef="qoh">
          <th mat-header-cell class="text-right" *matHeaderCellDef>{{ 'COMMON.QOH' | translate }}</th>
          <td mat-cell class="text-right" *matCellDef="let item">
            {{ item?.quantityOnHandTotal }}
          </td>
        </ng-container>
        <ng-container matColumnDef="estimatedQuantity">
          <th mat-header-cell class="text-right" *matHeaderCellDef>
            {{ 'MANUFACTURING.EST_QUANTITY' | translate }}
          </th>
          <td mat-cell class="text-right" *matCellDef="let item">
            {{ item?.estimatedQuantity }}
          </td>
        </ng-container>
        <ng-container matColumnDef="uom">
          <th mat-header-cell class="text-left" *matHeaderCellDef>{{ 'COMMON.UOM' | translate }}</th>
          <td mat-cell class="text-left" *matCellDef="let item">
            {{ item?.uom }}
          </td>
        </ng-container>
        <ng-container matColumnDef="produced">
          <th mat-header-cell class="text-right" *matHeaderCellDef>{{ 'MANUFACTURING.PRODUCED' | translate }}</th>
          <td mat-cell class="text-right" *matCellDef="let item">
            {{ item?.produced }}
          </td>
        </ng-container>
        <ng-container matColumnDef="inventoryItemIds">
          <th mat-header-cell class="text-left" *matHeaderCellDef>
            {{ 'MANUFACTURING.INVENTORY_ITEM_IDS' | translate }}
          </th>
          <td mat-cell class="text-left" *matCellDef="let item">
            <ng-container *ngIf="getProducedInventoryItemIds(item).length; else noInventoryItems">
              <a *ngFor="let inventoryItemId of getProducedInventoryItemIds(item); let last = last"
                [routerLink]="['/assets', inventoryItemId]">
                {{ inventoryItemId }}<span *ngIf="!last">, </span>
              </a>
            </ng-container>
            <ng-template #noInventoryItems>-</ng-template>
          </td>
        </ng-container>
        <ng-container matColumnDef="actions">
          <th mat-header-cell class="text-left" *matHeaderCellDef>{{ 'COMMON.ACTION' | translate }}</th>
          <td mat-cell class="text-left" *matCellDef="let item">
            <button mat-stroked-button color="primary" (click)="produceItem(item)" *ngIf="isApproved() && !isClosed()">
              {{ 'MANUFACTURING.PRODUCE' | translate }}
            </button>
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="productsToProduceColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: productsToProduceColumns"></tr>
      </table>
    </mat-card-content>
  </mat-card>
  <br />
  <mat-card class="mat-elevation-z10">
    <mat-card-header>
      <mat-card-title>
        <div class="card-title-row">
          <span>{{ 'MANUFACTURING.PRODUCTS_TO_CONSUME' | translate }}</span>
          <span class="spacer"></span>
          <button mat-button color="primary" (click)="addConsumable()" *ngIf="!isClosed()">
            <mat-icon>add</mat-icon>
            {{ 'MANUFACTURING.ADD_ITEM' | translate }}
          </button>
        </div>
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <table mat-table [dataSource]="productsToConsume">
        <ng-container matColumnDef="productId">
          <th mat-header-cell class="text-left" *matHeaderCellDef>
            {{ 'COMMON.PRODUCT_ID' | translate }}
          </th>
          <td mat-cell class="text-left" *matCellDef="let item">
            {{ item?.productId }}
          </td>
        </ng-container>
        <ng-container matColumnDef="productName">
          <th mat-header-cell class="text-left" *matHeaderCellDef>
            {{ 'COMMON.PRODUCT_NAME' | translate }}
          </th>
          <td mat-cell class="text-left" *matCellDef="let item">
            {{ item?.productName }}
          </td>
        </ng-container>
        <ng-container matColumnDef="atp">
          <th mat-header-cell class="text-right" *matHeaderCellDef>{{ 'COMMON.ATP' | translate }}</th>
          <td mat-cell class="text-right" *matCellDef="let item">
            {{ item?.availableToPromiseTotal }}
          </td>
        </ng-container>
        <ng-container matColumnDef="qoh">
          <th mat-header-cell class="text-right" *matHeaderCellDef>{{ 'COMMON.QOH' | translate }}</th>
          <td mat-cell class="text-right" *matCellDef="let item">
            {{ item?.quantityOnHandTotal }}
          </td>
        </ng-container>
        <ng-container matColumnDef="estimatedQuantity">
          <th mat-header-cell class="text-right" *matHeaderCellDef>
            {{ 'MANUFACTURING.EST_QUANTITY' | translate }}
          </th>
          <td mat-cell class="text-right" *matCellDef="let item">
            {{ item?.estimatedQuantity }}
          </td>
        </ng-container>
        <ng-container matColumnDef="uom">
          <th mat-header-cell class="text-left" *matHeaderCellDef>{{ 'COMMON.UOM' | translate }}</th>
          <td mat-cell class="text-left" *matCellDef="let item">
            {{ item?.uom }}
          </td>
        </ng-container>
        <ng-container matColumnDef="consumed">
          <th mat-header-cell class="text-right" *matHeaderCellDef>{{ 'MANUFACTURING.CONSUMED' | translate }}</th>
          <td mat-cell class="text-right" *matCellDef="let item">
            {{ item?.consumed }}
          </td>
        </ng-container>
        <ng-container matColumnDef="status">
          <th mat-header-cell class="text-left" *matHeaderCellDef>{{ 'COMMON.STATUS' | translate }}</th>
          <td mat-cell class="text-left" *matCellDef="let item">
            {{ statusLabel(item?.statusId) }}
          </td>
        </ng-container>
        <ng-container matColumnDef="actions">
          <th mat-header-cell class="text-left" *matHeaderCellDef>{{ 'COMMON.ACTION' | translate }}</th>
          <td mat-cell class="text-left" *matCellDef="let item">
            <button mat-stroked-button color="primary" (click)="reserveConsumable(item)"
              *ngIf="!isReserved(item) && isApproved() && !isCancelled(item) && !isIssued(item) && !isClosed()">
              {{ 'MANUFACTURING.RESERVE' | translate }}
            </button>
            <button mat-stroked-button color="accent" (click)="releaseConsumable(item)"
              *ngIf="isReserved(item) && !isCancelled(item) && !isIssued(item) && !isClosed()">
              {{ 'MANUFACTURING.RELEASE' | translate }}
            </button>
            <button mat-stroked-button color="warn" (click)="issueConsumable(item)"
              *ngIf="isReserved(item) && !isCancelled(item) && !isIssued(item) && !isClosed()">
              {{ 'MANUFACTURING.ISSUE' | translate }}
            </button>
            <button mat-button color="warn" (click)="cancelConsumable(item)"
              *ngIf="!isCancelled(item) && !isIssued(item) && !isClosed()">
              {{ 'COMMON.CANCEL' | translate }}
            </button>
          </td>
        </ng-container>
        <tr mat-header-row *matHeaderRowDef="productsToConsumeColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: productsToConsumeColumns"></tr>
      </table>
    </mat-card-content>
  </mat-card>
</ng-template>